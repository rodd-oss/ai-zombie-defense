# Ralph Progress Log
Started: Fri Jan 23 12:23:11 MSK 2026

## Codebase Patterns
- Use 'ai-zombie-defense/server/internal/services' for service interfaces and implementations.
- Each service module should have its own package under internal/services.
- Handlers should depend on service interfaces rather than concrete implementations (ongoing).
- Use `internal/api/gateway.APIGateway` for central routing and global middleware.

---

## 2026-01-23 12:25:01 - US-001
- Defined service interfaces and directory structure for the modular monolith refactor.
- Created internal/services directory with sub-packages for each service.
- Implemented Service interfaces for: auth, account, progression, match, server, social, leaderboard, and loot.
- Files changed:
  - packages/go/server/internal/services/auth/service.go
  - packages/go/server/internal/services/account/service.go
  - packages/go/server/internal/services/progression/service.go
  - packages/go/server/internal/services/match/service.go
  - packages/go/server/internal/services/server/service.go
  - packages/go/server/internal/services/social/service.go
  - packages/go/server/internal/services/leaderboard/service.go
  - packages/go/server/internal/services/loot/service.go
- **Learnings for future iterations:**
  - The codebase currently uses a large "god service" in pkg/auth/auth.go that needs to be broken down.
  - New service interfaces should be placed in internal/services to ensure isolation.
  - Workspace uses 'ai-zombie-defense/server' as the base module for internal packages.
---

## 2026-01-23 12:28:44 - US-002
- Migrated Auth service logic to internal/services/auth.
- Implemented AuthService interface and moved core auth logic (Authenticate, RegisterPlayer, Token/Session management).
- Updated pkg/auth.Service to delegate auth operations to the new internal service.
- Verified all Go tests pass, including new service tests and existing package tests.
- Files changed:
  - packages/go/server/internal/services/auth/implementation.go
  - packages/go/server/internal/services/auth/service_test.go
  - packages/go/server/pkg/auth/auth.go
  - packages/go/server/AGENTS.md
- **Learnings for future iterations:**
  - Migrating logic to internal/services while keeping pkg/auth as a delegator allows for incremental refactoring without breaking existing handlers.
  - Core errors (ErrInvalidCredentials, etc.) were moved to internal/services/auth and aliased in pkg/auth to maintain compatibility.
  - Future stories (Account, Progression) should follow this pattern of migrating logic from the "god service" in pkg/auth.
---

## 2026-01-23 12:45:12 - US-003
- Migrated Account service logic to internal/services/account.
- Implemented AccountService interface and moved profile/settings logic (GetPlayer, UpdatePlayerProfile, UpdatePlayerPassword, GetPlayerSettings, UpsertPlayerSettings).
- Updated pkg/auth.Service to delegate account operations to the new internal service.
- Unified duplicate username/email errors by sharing them between auth and account internal services.
- Updated AGENTS.md with Account Service guidelines.
- Files changed:
  - packages/go/server/internal/services/account/implementation.go
  - packages/go/server/pkg/auth/auth.go
  - packages/go/server/AGENTS.md
- **Learnings for future iterations:**
  - Internal services should share common domain errors (like ErrDuplicateUsername) to ensure consistent error handling across the modular monolith.
  - pkg/auth acts as a stable facade during the refactor, allowing handlers to remain unchanged while logic moves to internal services.
  - When migrating logic that involves bcrypt or other shared utilities, ensure all services use consistent implementations to avoid breaking tests or existing data.
---

## 2026-01-23 13:10:45 - US-004
- Migrated Progression and Loot service logic to internal/services.
- Implemented ProgressionService with XP, level-up, prestige, match rewards, and cosmetic purchasing logic.
- Implemented LootService with loot table management and weighted drop generation logic.
- Updated pkg/auth.Service to delegate progression and loot operations to the new internal services.
- Maintained temporary helpers in pkg/auth.Service for StoreMatchWithStats to preserve transactional integrity until match service migration.
- Updated AGENTS.md with Progression and Loot Service guidelines.
- Files changed:
  - packages/go/server/internal/services/progression/service.go
  - packages/go/server/internal/services/progression/implementation.go
  - packages/go/server/internal/services/loot/service.go
  - packages/go/server/internal/services/loot/implementation.go
  - packages/go/server/pkg/auth/auth.go
  - packages/go/server/AGENTS.md
- **Learnings for future iterations:**
  - Complex operations like StoreMatchWithStats that span multiple domains (Match, Progression) require careful handling of transactions during modularization.
  - Temporary helpers in the facade service (pkg/auth) can bridge the gap during incremental migration while keeping the public API stable.
  - Domain-specific errors (ErrCosmeticNotFound, etc.) should be defined in the internal service and aliased in the facade to maintain backward compatibility.
---

## 2026-01-23 13:35:12 - US-005
- Migrated Server and Match service logic to internal/services.
- Implemented MatchService with match storage and reward calculation logic (XP, match stats, data currency).
- Implemented ServerService with server registration, heartbeats, join tokens, and favorites management.
- Updated pkg/auth.Service to delegate server and match operations to the new internal services.
- Refined MatchService to depend on ProgressionService for consistent level/XP calculation during match reward processing.
- Files changed:
  - packages/go/server/internal/services/match/implementation.go
  - packages/go/server/internal/services/server/implementation.go
  - packages/go/server/pkg/auth/auth.go
  - packages/go/server/AGENTS.md
- **Learnings for future iterations:**
  - When migrating logic that spans multiple domains (like Match rewards affecting Progression), services can depend on each other's interfaces to maintain transactional integrity within the same database.
  - Using unexported helper methods (like `addMatchRewardsWithTx`) in internal services allows for clean code reuse while keeping the public interface focused.
  - pkg/auth.Service continues to serve as an effective delegation layer, allowing for a smooth transition to a modular monolith without breaking existing handler consumers.
---

## 2026-01-23 13:55:00 - US-006
- Implemented API Gateway for central routing and global middleware aggregation.
- Created internal/api/gateway/gateway.go with APIGateway struct.
- Configured Fiber router with global middleware (CORS, Logging, Recovery, Rate Limiting).
- Added MountGroup method to facilitate modular route registration.
- Updated AGENTS.md with API Gateway guidelines.
- Files changed:
  - packages/go/server/internal/api/gateway/gateway.go
  - packages/go/server/AGENTS.md
- **Learnings for future iterations:**
  - Moving global middleware and routing to a dedicated gateway service simplifies the main server setup and allows for better isolation of cross-cutting concerns.
  - Using a mounting pattern for routes allows each service module to define its own routing logic while the gateway maintains control over the overall path structure and global policies.
  - The gateway currently uses Fiber's Group method to provide a isolated router for each service.
---

## 2026-01-23 12:47:48 - US-007
- Updated all handlers in packages/go/server/pkg/handlers to depend on service interfaces from internal/services.
- Migrated remaining Social and Leaderboard logic to internal/services/social and internal/services/leaderboard.
- Updated NewAuthHandlers to accept both auth.Service and config.Config for token expiration settings.
- Updated AccountHandlers to depend on Account, Progression, and Match service interfaces.
- Updated FriendHandlers to depend on social.Service interface.
- Updated LeaderboardHandlers to depend on leaderboard.Service interface.
- Updated LootHandlers and LootTableHandlers to depend on loot.Service interface.
- Updated ServerHandlers and FavoriteHandlers to depend on server.Service interface.
- Updated pkg/server/server.go and tests to use the new handler constructors.
- Verified all Go tests pass and typecheck succeeds.
- Files changed:
  - packages/go/server/internal/services/social/service.go
  - packages/go/server/internal/services/social/implementation.go
  - packages/go/server/internal/services/leaderboard/service.go
  - packages/go/server/internal/services/leaderboard/implementation.go
  - packages/go/server/pkg/auth/auth.go
  - packages/go/server/pkg/handlers/auth.go
  - packages/go/server/pkg/handlers/account.go
  - packages/go/server/pkg/handlers/friends.go
  - packages/go/server/pkg/handlers/leaderboards.go
  - packages/go/server/pkg/handlers/loot.go
  - packages/go/server/pkg/handlers/loot_tables.go
  - packages/go/server/pkg/handlers/servers.go
  - packages/go/server/pkg/handlers/favorites.go
  - packages/go/server/pkg/server/server.go
  - packages/go/server/pkg/handlers/auth_test.go
  - packages/go/server/pkg/handlers/account_test.go
  - packages/go/server/AGENTS.md
- **Learnings for future iterations:**
  - Using interfaces for handlers allows for easier mocking in tests (though current tests still use the facade service).
  - The pkg/auth.Service acts as a useful "Mega-Service" that implements all internal service interfaces, facilitating a smooth transition.
  - When a handler needs settings from config (like JWT expiration), pass the config struct explicitly alongside service interfaces.
---
