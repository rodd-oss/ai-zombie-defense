# Ralph Progress Log
Started: Thu Jan 22 13:48:44 MSK 2026
---

## Codebase Patterns
- SQLite does not support ENUM types; use CHECK constraints with IN list
- Timestamp columns are TEXT with ISO 8601 format; use column-specific overrides in sqlc.yaml to map to time.Time
- Foreign key indexes are not automatically created; need explicit CREATE INDEX
- Migration files require `-- +goose Up` and `-- +goose Down` annotations with proper ordering (drop indexes before tables)
- Enable foreign keys with `PRAGMA foreign_keys = ON` and WAL mode with `PRAGMA journal_mode = WAL` on database connection
- Database connection pooling: Use `database.OpenDB(path)` with default settings (MaxOpenConns=5, MaxIdleConns=2, ConnMaxLifetime=5m, ConnMaxIdleTime=2m)
- Logging: Use zap logger with LOG_LEVEL and LOG_ENCODING environment variables (json/console)
- Configuration: Use viper with uppercase environment variables; JWT_SECRET required
- Use JWT ID (jti) claim with random bytes to ensure refresh token uniqueness
- Use Fiber v2 for HTTP server; import fiberLogger to avoid naming conflict with zap logger
- Fiber middleware: use c.Locals to pass data to downstream handlers; define constant keys for local keys
- Fiber's Shutdown method is ShutdownWithContext(ctx); call with timeout context
- Server configuration uses SERVER_HOST and SERVER_PORT environment variables (default 0.0.0.0:8080)
- Test HTTP servers using random free ports via net.Listen and zaptest.Logger
- Handle duplicate SQLite constraints by checking error strings; translate to user-friendly conflict errors
- Use middleware.GetPlayerID(c) to retrieve authenticated player ID in protected handlers
- Nullable columns in SQLite generate pointer types in sqlc (*string, *float64). Use sql.NullX for custom null handling if needed.
- SQLite does not support RETURNING clause in UPDATE statements; fetch updated rows separately after modification.
- Use LEFT JOIN with IS NULL for exclusion queries with sqlc; parameter numbering requires ?1, ?2 syntax.
- When adding new migrations, update the migration test's tables list and rollback verification

## 2026-01-22 10:51 UTC - US-001
- Converted ERD diagram to SQL migration files for all database tables
- Created 16 migration files in packages/go/db/migrations/ with proper foreign key constraints and indexes
- Files changed: packages/go/db/migrations/*.sql, scripts/ralph/prd.json
- **Learnings for future iterations:**
  - Database schema is defined in docs/c4/containers/database-erd.puml as PlantUML
  - SQLite does not support ENUM types; use CHECK constraints with IN list
  - Use TEXT for timestamps with ISO 8601 format (strftime)
  - Foreign key indexes are not automatically created; need explicit CREATE INDEX
  - Naming convention: YYYYMMDDHHMMSS_table_name.sql for goose migrations
---
## 2026-01-22 14:21 UTC - US-002
- Set up sqlc configuration and generated Go models for all database tables
- Files changed: packages/go/db/sqlc.yaml, packages/go/db/schema/schema.sql, packages/go/db/queries/player.sql, packages/go/db/generated/*, packages/go/db/go.mod, packages/go/db/go.sum, go.work
- **Learnings for future iterations:**
  - SQLite does not support ENUM types; use CHECK constraints with IN list
  - Timestamp columns are TEXT with ISO 8601 format; use column-specific overrides in sqlc.yaml to map to time.Time
  - Nullable timestamp columns need `pointer: true` in sqlc overrides to generate *time.Time
  - The go.work file must include module paths for go vet to work; currently only includes packages/go/db
  - Use sqlc generate with at least one query file referencing tables; placeholder SELECT 1 is insufficient
---

## 2026-01-22 14:42 UTC - US-003
- Implemented goose migration runner with SQLite driver
- Created migration CLI tool with up/down/status commands
- Added migration tests with in-memory SQLite database
- Updated all migration files with goose annotations
- Files changed: packages/go/db/migrations/*.sql, packages/go/db/pkg/migrations/migrations.go, packages/go/db/cmd/migrate/main.go, packages/go/db/pkg/migrations/migrations_test.go, packages/go/db/go.mod, packages/go/db/go.sum, packages/go/db/AGENTS.md
- **Learnings for future iterations:**
  - Goose migration files require specific annotations (`-- +goose Up` and `-- +goose Down`)
  - Down migrations must drop indexes before tables (reverse order)
  - Use `goose.SetDialect("sqlite")` before running migrations
  - The migration CLI enables foreign keys and WAL mode automatically
  - Test migrations with in-memory SQLite for speed and isolation
---

## 2026-01-22 11:52 UTC - US-004
- Created database connection pooling with WAL mode and foreign keys enabled
- Implemented OpenDB and OpenInMemory functions in pkg/database
- Added connection pool configuration with defaults (MaxOpenConns=5, MaxIdleConns=2, etc.)
- Files changed: packages/go/db/pkg/database/database.go, packages/go/db/pkg/database/database_test.go, packages/go/db/AGENTS.md, scripts/ralph/prd.json
- **Learnings for future iterations:**
  - Use `database.OpenDB(path)` for production connections; automatically enables foreign keys and WAL mode
  - Default pool settings are appropriate for SQLite; adjust based on workload
  - In-memory SQLite uses "memory" journal mode, not WAL; test accordingly
  - Connection pooling is essential for concurrent API requests; share *sql.DB instance across application
---

## 2026-01-22 14:58 UTC - US-005
- Set up structured logging with Zap logger and JSON/console output
- Configured environment variable loading with Viper
- Created config struct with database, server, and JWT settings
- Files changed: go.work, go.work.sum, packages/go/server/go.mod, packages/go/server/pkg/logging/*, packages/go/server/pkg/config/*, packages/go/server/AGENTS.md
- **Learnings for future iterations:**
  - Use zap logger with LOG_LEVEL and LOG_ENCODING environment variables
  - Viper automatically binds environment variables with uppercase names
  - JWT_SECRET is required; no default for security
  - Go workspace must include new modules in go.work
  - Run `go mod tidy` after adding dependencies
---

## 2026-01-22 12:12 UTC - US-006
- Implemented basic Fiber server with default middleware (logger, recover)
- Added GET /health endpoint returning 200 OK
- Server reads configuration for port and host via viper environment variables
- Created server package with New, Start, Shutdown methods
- Added cmd/server/main.go with graceful shutdown and signal handling
- Added comprehensive tests for server creation and health endpoint
- Files changed: packages/go/server/go.mod, packages/go/server/pkg/server/server.go, packages/go/server/cmd/server/main.go, packages/go/server/pkg/server/server_test.go, scripts/ralph/prd.json
- **Learnings for future iterations:**
  - Use Fiber v2 with default middleware; import fiberLogger to avoid naming conflict with zap logger
  - Fiber's Shutdown method requires context; use ShutdownWithContext(ctx)
  - Server config uses viper environment variables SERVER_HOST and SERVER_PORT (default 0.0.0.0:8080)
  - Test server using zaptest.Logger and random free ports via net.Listen
  - Go workspace includes server module; run `go mod tidy` after adding dependencies
---

## 2026-01-22 12:45 UTC - US-008
- Implemented login endpoint with JWT token generation and password verification
- Created auth service with bcrypt hashing and JWT token generation
- Added auth handlers and integrated with Fiber server
- Added new SQL queries for player lookup by username/email
- Updated server to accept database connection and register auth routes
- Files changed: packages/go/db/queries/player.sql, packages/go/db/generated/*, packages/go/server/go.mod, packages/go/server/pkg/auth/*, packages/go/server/pkg/handlers/auth.go, packages/go/server/pkg/server/server.go, packages/go/server/pkg/server/server_test.go, packages/go/server/cmd/server/main.go, packages/go/server/pkg/auth/auth_service_test.go
- **Learnings for future iterations:**
  - SQLite driver (modernc.org/sqlite) may not automatically convert TEXT to time.Time; need to configure sqlc overrides properly
  - Workspace cross-module imports require .go files in module root; moved sqlc generated files to root to resolve import issues
  - Authentication service should handle scanning errors gracefully
  - Use consistent naming for database connection field to avoid shadowing package name
---

## 2026-01-22 14:10 UTC - US-009
- Implemented token refresh and logout endpoints
- Added JWT JTI claim to ensure refresh token uniqueness
- Created integration tests for auth handlers
- Files changed: packages/go/server/pkg/auth/auth.go, packages/go/server/pkg/handlers/auth_test.go
- **Learnings for future iterations:**
  - Use JWT ID (jti) claim with random bytes to guarantee token uniqueness
  - Fiber's app.Test() is convenient for handler testing without starting server
  - SQLite unique constraint errors should be handled gracefully (duplicate token case)
---

## 2026-01-22 14:20 UTC - US-010
- Implemented JWT middleware for protected endpoints (AuthMiddleware)
- Added helper functions GetPlayerID and GetClaims to retrieve data from Fiber locals
- Created comprehensive tests for middleware with valid/invalid tokens
- Files changed: packages/go/server/pkg/middleware/auth.go, packages/go/server/pkg/middleware/auth_test.go
- **Learnings for future iterations:**
  - Fiber middleware pattern expects a function returning fiber.Handler
  - Use c.Locals to pass data to downstream handlers; keys should be constants
  - Token validation uses auth.Service.ValidateToken; subject claim contains player ID as string
---

## 2026-01-22 15:30 UTC - US-011
- Implemented account profile management API with GET /account/profile and PUT /account/profile endpoints
- Protected by JWT middleware with duplicate username/email validation
- Added SQL queries for updating player profile and password
- Created auth service methods for profile management
- Added comprehensive tests for both endpoints
- Files changed: packages/go/db/queries/player.sql, packages/go/db/player.sql.go, packages/go/server/pkg/auth/auth.go, packages/go/server/pkg/handlers/account.go, packages/go/server/pkg/server/server.go, packages/go/server/pkg/handlers/account_test.go, scripts/ralph/prd.json
- **Learnings for future iterations:**
  - Use existing helper functions in test files to avoid duplication
  - SQLite unique constraint errors need to be caught and translated to user-friendly errors
  - Profile endpoints must exclude sensitive fields like password_hash
  - JWT middleware automatically extracts player ID; use middleware.GetPlayerID in handlers
  - Use server.New for full integration tests instead of manually building routes
---

## 2026-01-22 18:05 UTC - US-012
- Implemented player settings storage and retrieval API with GET /account/settings and PUT /account/settings endpoints
- Added SQL queries for player_settings table (GetPlayerSettings, UpsertPlayerSettings)
- Created auth service methods for settings management with default values when no settings exist
- Added JWT middleware protected routes in server
- Updated test database setup to include player_settings table
- Added comprehensive tests for both endpoints covering default values, updates, null handling, and error cases
- Files changed: packages/go/db/queries/player_settings.sql, packages/go/db/player_settings.sql.go, packages/go/server/pkg/auth/auth.go, packages/go/server/pkg/handlers/account.go, packages/go/server/pkg/server/server.go, packages/go/server/pkg/handlers/auth_test.go, packages/go/server/pkg/handlers/account_test.go
- **Learnings for future iterations:**
  - SQLite nullable columns map to Go pointers in sqlc generated models (*string, *float64)
  - Default settings pattern: return zero-value struct when row not found to avoid extra database writes
  - Use sqlc's Upsert with ON CONFLICT DO UPDATE for simple create-or-update semantics
  - Test database setup must include all required tables; update auth_test.go's setupTestDB function when adding new tables
  - Fiber handler pattern: extract player ID via middleware.GetPlayerID, use service methods, return consistent error responses
---

## 2026-01-22 18:45 UTC - US-013
- Implemented GET /progression endpoint (also available at /account/progression) with JWT middleware protection
- XP gains calculated via AddMatchRewards method using performance-based formula
- Level-up thresholds configured via PROGRESSION_BASE_XP_PER_LEVEL environment variable
- Added new route group `/progression` for future progression-related endpoints
- Updated tests to cover both route paths
- Files changed: packages/go/server/pkg/server/server.go, packages/go/server/pkg/handlers/account_test.go, scripts/ralph/prd.json
- **Learnings for future iterations:**
  - The same handler can be registered under multiple routes (e.g., /account/progression and /progression)
  - Progression endpoint uses existing auth service method GetPlayerProgression which creates default row if missing
  - XP calculation uses config.BaseXPPerLevel for level thresholds; match reward XP is hardcoded but can be moved to config later
  - When adding new route groups, ensure JWT middleware is applied to the group
---
## 2026-01-22 19:05 UTC - US-014
- Implemented POST /progression/prestige endpoint with JWT middleware protection
- Added PrestigePlayer method to auth service with transaction support
- Added SQL queries for prestige operation and cosmetic granting
- Updated server routes to include POST /progression/prestige
- Files changed: packages/go/db/queries/player_progression.sql, packages/go/db/queries/cosmetic_items.sql, packages/go/db/*.sql.go, packages/go/server/pkg/auth/auth.go, packages/go/server/pkg/handlers/account.go, packages/go/server/pkg/server/server.go, packages/go/server/pkg/auth/auth_service_test.go (added cosmetic tables), scripts/ralph/prd.json
- **Learnings for future iterations:**
  - SQLite does not support RETURNING in UPDATE; need to fetch updated row separately
  - Use LEFT JOIN for exclusion queries with sqlc parameter numbering
  - Fiber handlers can reuse existing account handlers; no need for separate progression handler
  - Prestige cosmetics are identified by is_prestige_only flag and unlock_level as prestige requirement
---

## 2026-01-22 19:47 UTC - US-016
- Implemented cosmetic catalog and ownership system with GET /cosmetics/catalog and GET /cosmetics/owned endpoints
- Added SQL queries for catalog (GetCosmeticCatalog) and player-owned cosmetics (GetPlayerCosmetics)
- Added auth service methods, handlers, routes, and integration tests
- Files changed: cosmetic_items.sql, player_cosmetics.sql, generated Go models, auth.go, account.go, server.go, account_test.go, auth_test.go, prd.json
- **Learnings for future iterations:**
  - SQLite CHECK constraints can be used for enumerated types (slot, rarity, unlocked_via)
  - JOIN queries with sqlc require explicit column selection; use LEFT JOIN for exclusion logic
  - New endpoints follow pattern: add SQL query, generate models, add service method, add handler, register route, write tests
  - Test database setup must include all required tables; added cosmetic_items and player_cosmetics to setupTestDB
---

## 2026-01-22 20:37 UTC - US-017
- Implemented loadout management for equipped cosmetics (PUT /cosmetics/equip endpoint already existed)
- Added banner slot to cosmetic slot types in CHECK constraints
- Updated migration test to include currency_transactions table and correct rollback verification
- Files changed: packages/go/db/migrations/20260122105151_cosmetic_items.sql, packages/go/db/migrations/20260122105154_loadout_cosmetics.sql, packages/go/db/pkg/migrations/migrations_test.go, scripts/ralph/prd.json
- **Learnings for future iterations:**
  - When adding new migrations, update the migration test's tables list and rollback verification accordingly
  - Cosmetic slot types are defined in CHECK constraints; adding new types requires updating both cosmetic_items and loadout_cosmetics tables
  - EquipCosmetic endpoint automatically creates default loadout if none exists
---
