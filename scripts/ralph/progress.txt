# Ralph Progress Log
Started: Thu Jan 22 13:48:44 MSK 2026
---

## Codebase Patterns
- SQLite does not support ENUM types; use CHECK constraints with IN list
- Timestamp columns are TEXT with ISO 8601 format; use column-specific overrides in sqlc.yaml to map to time.Time
- Foreign key indexes are not automatically created; need explicit CREATE INDEX
- Migration files require `-- +goose Up` and `-- +goose Down` annotations with proper ordering (drop indexes before tables)
- Enable foreign keys with `PRAGMA foreign_keys = ON` and WAL mode with `PRAGMA journal_mode = WAL` on database connection
- Database connection pooling: Use `database.OpenDB(path)` with default settings (MaxOpenConns=5, MaxIdleConns=2, ConnMaxLifetime=5m, ConnMaxIdleTime=2m)
- Logging: Use zap logger with LOG_LEVEL and LOG_ENCODING environment variables (json/console)
- Configuration: Use viper with uppercase environment variables; JWT_SECRET required
- Use Fiber v2 for HTTP server; import fiberLogger to avoid naming conflict with zap logger
- Fiber's Shutdown method is ShutdownWithContext(ctx); call with timeout context
- Server configuration uses SERVER_HOST and SERVER_PORT environment variables (default 0.0.0.0:8080)
- Test HTTP servers using random free ports via net.Listen and zaptest.Logger

## 2026-01-22 10:51 UTC - US-001
- Converted ERD diagram to SQL migration files for all database tables
- Created 16 migration files in packages/go/db/migrations/ with proper foreign key constraints and indexes
- Files changed: packages/go/db/migrations/*.sql, scripts/ralph/prd.json
- **Learnings for future iterations:**
  - Database schema is defined in docs/c4/containers/database-erd.puml as PlantUML
  - SQLite does not support ENUM types; use CHECK constraints with IN list
  - Use TEXT for timestamps with ISO 8601 format (strftime)
  - Foreign key indexes are not automatically created; need explicit CREATE INDEX
  - Naming convention: YYYYMMDDHHMMSS_table_name.sql for goose migrations
---
## 2026-01-22 14:21 UTC - US-002
- Set up sqlc configuration and generated Go models for all database tables
- Files changed: packages/go/db/sqlc.yaml, packages/go/db/schema/schema.sql, packages/go/db/queries/player.sql, packages/go/db/generated/*, packages/go/db/go.mod, packages/go/db/go.sum, go.work
- **Learnings for future iterations:**
  - SQLite does not support ENUM types; use CHECK constraints with IN list
  - Timestamp columns are TEXT with ISO 8601 format; use column-specific overrides in sqlc.yaml to map to time.Time
  - Nullable timestamp columns need `pointer: true` in sqlc overrides to generate *time.Time
  - The go.work file must include module paths for go vet to work; currently only includes packages/go/db
  - Use sqlc generate with at least one query file referencing tables; placeholder SELECT 1 is insufficient
---

## 2026-01-22 14:42 UTC - US-003
- Implemented goose migration runner with SQLite driver
- Created migration CLI tool with up/down/status commands
- Added migration tests with in-memory SQLite database
- Updated all migration files with goose annotations
- Files changed: packages/go/db/migrations/*.sql, packages/go/db/pkg/migrations/migrations.go, packages/go/db/cmd/migrate/main.go, packages/go/db/pkg/migrations/migrations_test.go, packages/go/db/go.mod, packages/go/db/go.sum, packages/go/db/AGENTS.md
- **Learnings for future iterations:**
  - Goose migration files require specific annotations (`-- +goose Up` and `-- +goose Down`)
  - Down migrations must drop indexes before tables (reverse order)
  - Use `goose.SetDialect("sqlite")` before running migrations
  - The migration CLI enables foreign keys and WAL mode automatically
  - Test migrations with in-memory SQLite for speed and isolation
---

## 2026-01-22 11:52 UTC - US-004
- Created database connection pooling with WAL mode and foreign keys enabled
- Implemented OpenDB and OpenInMemory functions in pkg/database
- Added connection pool configuration with defaults (MaxOpenConns=5, MaxIdleConns=2, etc.)
- Files changed: packages/go/db/pkg/database/database.go, packages/go/db/pkg/database/database_test.go, packages/go/db/AGENTS.md, scripts/ralph/prd.json
- **Learnings for future iterations:**
  - Use `database.OpenDB(path)` for production connections; automatically enables foreign keys and WAL mode
  - Default pool settings are appropriate for SQLite; adjust based on workload
  - In-memory SQLite uses "memory" journal mode, not WAL; test accordingly
  - Connection pooling is essential for concurrent API requests; share *sql.DB instance across application
---

## 2026-01-22 14:58 UTC - US-005
- Set up structured logging with Zap logger and JSON/console output
- Configured environment variable loading with Viper
- Created config struct with database, server, and JWT settings
- Files changed: go.work, go.work.sum, packages/go/server/go.mod, packages/go/server/pkg/logging/*, packages/go/server/pkg/config/*, packages/go/server/AGENTS.md
- **Learnings for future iterations:**
  - Use zap logger with LOG_LEVEL and LOG_ENCODING environment variables
  - Viper automatically binds environment variables with uppercase names
  - JWT_SECRET is required; no default for security
  - Go workspace must include new modules in go.work
  - Run `go mod tidy` after adding dependencies
---

## 2026-01-22 12:12 UTC - US-006
- Implemented basic Fiber server with default middleware (logger, recover)
- Added GET /health endpoint returning 200 OK
- Server reads configuration for port and host via viper environment variables
- Created server package with New, Start, Shutdown methods
- Added cmd/server/main.go with graceful shutdown and signal handling
- Added comprehensive tests for server creation and health endpoint
- Files changed: packages/go/server/go.mod, packages/go/server/pkg/server/server.go, packages/go/server/cmd/server/main.go, packages/go/server/pkg/server/server_test.go, scripts/ralph/prd.json
- **Learnings for future iterations:**
  - Use Fiber v2 with default middleware; import fiberLogger to avoid naming conflict with zap logger
  - Fiber's Shutdown method requires context; use ShutdownWithContext(ctx)
  - Server config uses viper environment variables SERVER_HOST and SERVER_PORT (default 0.0.0.0:8080)
  - Test server using zaptest.Logger and random free ports via net.Listen
  - Go workspace includes server module; run `go mod tidy` after adding dependencies
---
